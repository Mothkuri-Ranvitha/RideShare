<div class="shell">
  <header class="topbar">
    <div class="brand">
      <img
        class="brand-icon"
        src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png"
        alt="Admin icon"
      />
      <div>
        <h1>Admin Dashboard</h1>
        <p>Manage users, drivers, rides and platform activity.</p>
      </div>
    </div>
    <a routerLink="/" class="link">Back to site</a>
  </header>

  <p class="banner success" *ngIf="banner()">{{ banner() }}</p>
  <p class="error" *ngIf="error()">{{ error() }}</p>

  <nav class="tabs">
    <button class="tab" [class.active]="activeTab==='team'" (click)="setTab('team')">
      Team ({{ countTeam() }})
    </button>
    <button class="tab" [class.active]="activeTab==='drivers'" (click)="setTab('drivers')">
      Drivers ({{ countDrivers() }})
    </button>
    <button class="tab" [class.active]="activeTab==='users'" (click)="setTab('users')">
      Users ({{ countUsers() }})
    </button>
    <button class="tab" [class.active]="activeTab==='rides'" (click)="setTab('rides')">
      Rides ({{ countRides() }})
    </button>
    <button class="tab" [class.active]="activeTab==='requests'" (click)="setTab('requests')">
      Requests ({{ countRequests() }}) <span class="dot" *ngIf="countRequests() > 0"></span>
    </button>
  </nav>

  <section class="card" *ngIf="activeTab!=='rides'">
    <header class="section-header">
      <div class="section-title">
        <img
          src="https://cdn-icons-png.flaticon.com/512/1251/1251840.png"
          alt="Users"
        />
        <div>
          <h2>{{ activeTab==='team' ? 'Team' : activeTab==='drivers' ? 'Drivers' : activeTab==='requests' ? 'Requests' : 'Users' }}</h2>
          <p>Select a user at the top to edit or delete.</p>
      </div>
    </div>
    <div class="edit-toolbar" *ngIf="users().length">
        <select [(ngModel)]="selectedUserId" name="selectedUser">
          <option [ngValue]="null">Select user…</option>
          <option *ngFor="let u of users()" [ngValue]="u.id">
            {{ u.email }} ({{ u.role }})
          </option>
        </select>
        <button type="button" (click)="startEditFromToolbar()">Edit</button>
        <button type="button" class="danger" (click)="deleteFromToolbar()">Delete</button>
      </div>
    </header>
    <div class="table">
      <div class="row head">
        <div>Email</div><div>Role</div><div>Name</div><div>Status</div><div>Actions</div>
      </div>
      <div class="row" *ngFor="let u of displayUsers()">
        <div>{{ u.email }}</div>
        <div>{{ u.role }}</div>
        <div>{{ u.name }}</div>
        <div>
          <span *ngIf="u.blocked" class="pill pill-red">Blocked</span>
          <span *ngIf="!u.blocked" class="pill pill-green">Active</span>
          <span *ngIf="u.role==='ROLE_DRIVER'" class="pill" [class.pill-green]="u.driverVerified" [class.pill-yellow]="!u.driverVerified">Driver {{ u.driverVerified ? 'Verified' : 'Unverified' }}</span>
        </div>
        <div class="actions">
          <button (click)="blockUser(u, !u.blocked)">{{ u.blocked ? 'Unblock' : 'Block' }}</button>
          <button *ngIf="u.role==='ROLE_DRIVER' && !u.driverVerified" (click)="verifyDriver(u)">Verify</button>
        </div>
      </div>
    </div>

    <div class="edit-panel" *ngIf="editingUser() as eu">
      <h3>Edit user: {{ eu.email }}</h3>
      <form (ngSubmit)="saveEdit()">
        <div class="edit-grid">
          <label>
            Name
            <input type="text" [(ngModel)]="editModel.name" name="name" />
          </label>
          <label>
            Phone
            <input type="text" [(ngModel)]="editModel.phone" name="phone" />
          </label>
          <label>
            Role
            <select [(ngModel)]="editModel.role" name="role">
              <option value="ROLE_ADMIN">Admin</option>
              <option value="ROLE_DRIVER">Driver</option>
              <option value="ROLE_PASSENGER">Passenger</option>
            </select>
          </label>
          <label>
            Blocked
            <input type="checkbox" [(ngModel)]="editModel.blocked" name="blocked" />
          </label>
          <label>
            Driver verified
            <input type="checkbox" [(ngModel)]="editModel.driverVerified" name="driverVerified" />
          </label>
          <label>
            Vehicle model
            <input type="text" [(ngModel)]="editModel.vehicleModel" name="vehicleModel" />
          </label>
          <label>
            License plate
            <input type="text" [(ngModel)]="editModel.licensePlate" name="licensePlate" />
          </label>
          <label>
            Capacity
            <input type="number" min="1" [(ngModel)]="editModel.capacity" name="capacity" />
          </label>
        </div>
        <div class="edit-actions">
          <button type="submit">Save changes</button>
          <button type="button" class="ghost" (click)="cancelEdit()">Cancel</button>
        </div>
      </form>
    </div>
  </section>

  <section class="card" *ngIf="activeTab==='rides'">
    <header class="section-header">
      <div class="section-title">
        <img
          src="https://cdn-icons-png.flaticon.com/512/684/684908.png"
          alt="Rides"
        />
        <div>
          <h2>Rides</h2>
          <p>Overview of active rides in the system.</p>
        </div>
      </div>
    </header>
    <div class="table">
      <div class="row head">
        <div>Route</div><div>Date</div><div>Seats</div><div>Fare</div>
      </div>
      <div class="row" *ngFor="let r of rides()">
        <div>{{ r.source }} → {{ r.destination }}</div>
        <div>{{ r.departureTime | date:'medium' }}</div>
        <div>{{ r.availableSeats }}</div>
        <div>₹{{ r.farePerSeat }}</div>
      </div>
    </div>
  </section>
</div>
